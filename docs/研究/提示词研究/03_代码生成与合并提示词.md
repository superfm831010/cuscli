# 代码生成与合并提示词

## 概述

代码生成与合并提示词是 autocoder 最核心的功能模块之一，负责将 AI 生成的代码安全、准确地应用到实际项目中。这些提示词定义了多种代码生成格式和合并策略。

## 代码生成格式

autocoder 支持多种代码生成格式，每种格式都有对应的提示词定义。

### 1. EditBlock 格式

**文件位置**：
- `autocoder/common/code_auto_generate_editblock.py`
- `autocoder/common/v2/code_auto_generate_editblock.py`

**特点**：
- 使用 `<EDIT>` 和 `</EDIT>` 标签标记修改区域
- 包含上下文行，帮助定位修改位置
- 适合小范围的精确修改

**示例格式**：
```
<<<<<<< EDIT path/to/file.py
上下文代码
====
修改前的代码
====
修改后的代码
====
更多上下文代码
>>>>>>>
```

### 2. Diff 格式

**文件位置**：
- `autocoder/common/code_auto_generate_diff.py`
- `autocoder/common/v2/code_auto_generate_diff.py`

**特点**：
- 类似 Git diff 的格式
- 使用 `@@ -行号,行数 +行号,行数 @@` 标记变更
- 支持多文件变更

**示例格式**：
```diff
--- a/path/to/file.py
+++ b/path/to/file.py
@@ -10,5 +10,6 @@
 上下文代码
-删除的代码
+添加的代码
 上下文代码
```

### 3. Strict Diff 格式

**文件位置**：
- `autocoder/common/code_auto_generate_strict_diff.py`
- `autocoder/common/v2/code_auto_generate_strict_diff.py`

**特点**：
- 更严格的 diff 格式
- 要求精确匹配
- 减少合并冲突的可能性

### 4. 基础代码生成

**文件位置**：
- `autocoder/common/code_auto_generate.py`
- `autocoder/common/v2/code_auto_generate.py`

**特点**：
- 直接生成完整文件内容
- 适合创建新文件或完全重写

## 关键提示词示例

### 代码生成提示词模式

虽然具体提示词内容在各个文件中，但通常遵循以下模式：

```python
@byzerllm.prompt()
def generate_code(self, context: dict) -> str:
    """
    你是一个专业的代码生成助手。

    任务：根据用户需求生成/修改代码

    上下文信息：
    - 项目类型：{{ project_type }}
    - 编程语言：{{ language }}
    - 相关文件：{{ files }}

    用户需求：
    {{ query }}

    请使用 [格式名称] 格式生成代码修改：

    [格式说明和示例]

    注意事项：
    1. 保持代码风格一致
    2. 添加适当的注释
    3. 考虑边界情况
    4. 遵循最佳实践
    """
```

## 代码合并策略

### 1. EditBlock 合并

**文件位置**：
- `autocoder/common/code_auto_merge_editblock.py`
- `autocoder/common/v2/code_auto_merge_editblock.py`

**策略**：
1. 解析 EditBlock 标记
2. 定位修改区域
3. 应用修改
4. 验证语法

### 2. Diff 合并

**文件位置**：
- `autocoder/common/v2/code_auto_merge_diff.py`

**策略**：
1. 解析 diff 格式
2. 应用补丁
3. 处理冲突
4. 验证完整性

### 3. Strict Diff 合并

**文件位置**：
- `autocoder/common/v2/code_auto_merge_strict_diff.py`

**策略**：
1. 严格匹配检查
2. 精确定位
3. 安全应用
4. 回滚机制

## V2 版本改进

`autocoder/common/v2/` 目录下的提示词是改进版本，主要改进：

1. **更精确的定位**：使用行号和上下文双重定位
2. **更好的错误处理**：提供详细的错误信息和修复建议
3. **更强的兼容性**：支持更多编程语言和文件类型
4. **更快的处理速度**：优化了解析和合并算法

## Manager 类

### Code Manager

**文件位置**：
- `autocoder/common/v2/code_manager.py`

**功能**：
- 统一管理代码生成和合并
- 选择最佳策略
- 处理失败和回滚

### EditBlock Manager

**文件位置**：
- `autocoder/common/v2/code_editblock_manager.py`
- `autocoder/common/v2/code_agentic_editblock_manager.py`

**功能**：
- EditBlock 格式的专用管理器
- 支持 Agentic 模式的增强功能

### Diff Manager

**文件位置**：
- `autocoder/common/v2/code_diff_manager.py`
- `autocoder/common/v2/code_strict_diff_manager.py`

**功能**：
- Diff 格式的专用管理器
- 支持标准和严格两种模式

## 设计模式

### 1. 策略模式
不同的代码格式和合并策略可以互换使用

### 2. 模板方法模式
定义代码生成和合并的通用流程，子类实现具体步骤

### 3. 责任链模式
尝试多种策略，直到成功或全部失败

## 使用场景

| 格式 | 适用场景 | 优点 | 缺点 |
|-----|---------|------|-----|
| EditBlock | 小范围精确修改 | 清晰直观 | 不适合大规模重构 |
| Diff | 多文件多处修改 | Git 兼容 | 可能有合并冲突 |
| Strict Diff | 关键代码修改 | 安全可靠 | 要求精确匹配 |
| 完整生成 | 新文件创建 | 简单直接 | 无法保留原有内容 |

## 最佳实践

1. **优先使用 EditBlock**：对于单文件的局部修改
2. **使用 Diff**：对于跨文件的协调修改
3. **使用 Strict Diff**：对于生产环境的关键代码
4. **使用完整生成**：对于全新的文件或模块

## 提示词设计要点

1. **明确格式要求**：清楚说明输出格式
2. **提供充足示例**：展示正确和错误的示例
3. **强调上下文**：要求包含足够的上下文行
4. **验证机制**：要求 AI 进行自我检查
5. **错误处理**：说明如何处理边界情况

---

**文档创建时间**：2025-10-17
**相关文件**：
- `autocoder/common/code_auto_generate*.py`
- `autocoder/common/code_auto_merge*.py`
- `autocoder/common/v2/code_*.py`
